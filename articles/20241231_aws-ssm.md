---
title: "AWS SSM Document å€‹äººãƒ¡ãƒ¢"
emoji: "ğŸ¥"
type: "tech"
topics: ["AWS", "SSM", "EC2"]
published: true
---

## ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒ¼ãƒ‰

SSMã®æ©Ÿèƒ½ã‚’åˆ©ç”¨å¯èƒ½ã«ã—ãŸEC2

ãƒ»`SSM Agent` ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ (Amazon Linuxã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿)
ãƒ»`SSMã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ` ã¸ã®é€šä¿¡ãŒå¯èƒ½ãªã“ã¨ (Internet Gatewayã¾ãŸã¯VPC Endpoint)
ãƒ»`IAMãƒ­ãƒ¼ãƒ«` (AmazonSSMManagedInstanceCore) ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## Run Command

ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒãƒ¼ãƒ‰ã®EC2ã«å¯¾ã—ã¦ã€`Document` (å‡¦ç†)ã‚’å®Ÿè¡Œå¯èƒ½
`AWS-RunShellScript` ã‚’ä½¿ç”¨ã™ã‚Œã°ã€è¤‡æ•°ã®EC2(Linux)ã«å¯¾ã—ã¦ã€è¤‡æ•°ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œå¯èƒ½

| Documentå | èª¬æ˜ |
| --- | --- |
| AWS-RunShellScript | ShellScriptã‚’å®Ÿè¡Œ (Linux) |
| AWS-RunPowerShellScript | PowerShellScriptã‚’å®Ÿè¡Œ (Windows) |
| AWS-RunPatchBaseline | ãƒ‘ãƒƒãƒé©ç”¨ |
| AWS-InstallWindowsUpdates | (ç‰¹å®šã®KBã®) Windows Updateã‚’é©ç”¨ |
| AWS-UpdateSSMAgent | SSM Agentã‚’æ›´æ–° |
| AWS-ConfigureAWSPackage | CloudWatch Agentç­‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/æ›´æ–° |
| AWS-GatherSoftwareInventory | SSM Inventoryç”¨ã«OSæƒ…å ±ã‚’å–å¾— |

## Maintenance Windows ã¨ State Manager Association (é–¢é€£ä»˜ã‘) ã®é•ã„

ã©ã¡ã‚‰ã‚‚ `Document` ã‚’å®šæœŸçš„ã«å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹æ©Ÿèƒ½
EC2ã®OSã‚„Agentã‚’å¸¸ã«æœ€æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿ã¡ãŸã„å ´åˆã¯ã€`State Manager Association` ã®æ–¹ãŒã‚ˆã„

| é …ç›® | Maintenance Windows | State Manager Association |
| --- | --- | --- |
| å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«(Cron/Rate) | ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«(Cron/Rate)<br>ãƒ»EC2ä½œæˆæ™‚<br>ãƒ»30æ—¥ä»¥ä¸Šåœæ­¢ã—ã¦ã„ãŸEC2ãŒèµ·å‹•ã—ãŸå ´åˆ |
| å®Ÿè¡Œå¯¾è±¡ | ãƒ»Document<br>ãƒ»Automation<br>ãƒ»Lambda<br>ãƒ»Step Functions | ãƒ»Document |

## ã‚«ã‚¹ã‚¿ãƒ ã®Documentã‚’ä½œæˆã™ã‚‹ä¾‹

è¤‡æ•°ã®Documentã‚’å®Ÿè¡Œã—ãŸã‚Šã€ShellScriptã‚’å®Ÿè¡Œã—ãŸã‚Šã™ã‚‹å ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ ã®Documentã‚’ä½œæˆã™ã‚‹ã¨ã‚ˆã„
â€»`AWS-UpdateSSMAgent` ã¯å®Ÿè¡Œã§ããªã„ãŸã‚æ³¨æ„

https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/documents-command-ssm-plugin-reference.html#aws-rundocument

ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹Documentã‚’ä½œæˆã™ã‚‹ä¾‹

ãƒ»SSM Agentã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãƒ»CloudWatch Agentã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ

```json
{
  "schemaVersion": "2.2",
  "description": "Update SSM Agent and CloudWatch Agent, Create Linux User",
  "parameters": {
    "version": {
      "default": "",
      "description": "(Optional) A specific version of the Amazon SSM Agent to install. If not specified, the agent will be updated to the latest version.",
      "type": "String"
    },
    "allowDowngrade": {
      "default": "false",
      "description": "(Optional) Allow the Amazon SSM Agent service to be downgraded to an earlier version. If set to false, the service can be upgraded to newer versions only (default). If set to true, specify the earlier version.",
      "type": "String",
      "allowedValues": [
        "true",
        "false"
      ]
    },
    "username": {
      "type": "String",
      "description": "(Required) The name of the user to create."
    },
    "password": {
      "type": "String",
      "description": "(Required) The password for the user."
    }
  },
  "mainSteps": [
    {
      "action": "aws:updateSsmAgent",
      "name": "awsupdateSsmAgent",
      "inputs": {
        "agentName": "amazon-ssm-agent",
        "source": "https://s3.{Region}.amazonaws.com/amazon-ssm-{Region}/ssm-agent-manifest.json",
        "allowDowngrade": "{{ allowDowngrade }}",
        "targetVersion": "{{ version }}"
      }
    },
    {
      "action": "aws:runDocument",
      "name": "UpdateCloudWatchAgent",
      "inputs": {
        "documentType": "SSMDocument",
        "documentPath": "AWS-ConfigureAWSPackage",
        "documentParameters": {
          "action": "Install",
          "installationType": "Uninstall and reinstall",
          "name": "AmazonCloudWatchAgent",
          "version": "latest"
        }
      }
    },
    {
      "action": "aws:runShellScript",
      "name": "runShellScript",
      "precondition": {
        "StringEquals": [
          "platformType",
          "Linux"
        ]
      },
      "inputs": {
        "timeoutSeconds": "60",
        "runCommand": [
          "#!/bin/bash",
          "USERNAME={{ username }}",
          "PASSWORD={{ password }}",
          "if ! id \"$USERNAME\" &>/dev/null; then",
          "  sudo useradd $USERNAME",
          "  echo \"$USERNAME:$PASSWORD\" | sudo chpasswd",
          "  echo \"User $USERNAME has been created\"",
          "else",
          "  echo \"User $USERNAME already exists\"",
          "fi"
        ]
      }
    }
  ]
}
```

`Inventory` ã‹ã‚‰ã€ãƒ‘ãƒƒãƒé©ç”¨ã‚„OSãƒ¦ãƒ¼ã‚¶ã‚’ç¢ºèªã™ã‚‹ä¾‹

![](/images/20241231_aws-ssm/1.png)
![](/images/20241231_aws-ssm/2.png)
