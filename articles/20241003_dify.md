---
title: "Difyå°å…¥ å€‹äººãƒ¡ãƒ¢"
emoji: "ğŸ—‚"
type: "tech"
topics: ["aws", "dify", "bedrock"]
published: true
---

æ€¥ã« RAG ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’å°å…¥ã™ã‚‹ã“ã¨ã«ãªã£ãŸã®ã§â€¦
å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™
å®šæœŸçš„ã«æ›´æ–°ã—ã¾ã™
â€»2024/10/03 æ™‚ç‚¹ã§ã®æƒ…å ±ã§ã™

## Install Docker Compose

https://zenn.dev/rock_penguin/articles/28875c7b0a5e30<br>
https://github.com/docker/compose/releases/<br>

â€»ä»¥ä¸‹ã® v2.29.7 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64

```bash
sudo -s
cd
dnf update
dnf install -y docker
systemctl start docker
gpasswd -a $(whoami) docker
chgrp docker /var/run/docker.sock
systemctl restart docker
systemctl enable docker
curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

ã€Œuname -sã€ã¯ OS åã€ä¾‹ãˆã°ã€ŒLinuxã€
ã€Œuname -mã€ã¯ CPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ä¾‹ãˆã°ã€Œx86_64ã€<br>

```bash
docker -v
docker-compose -v
```

## Install Git

```bash
dnf install -y git
```

## Install Dify

https://docs.dify.ai/ja-jp/getting-started/install-self-hosted/docker-compose#difyno<br>
https://github.com/langgenius/dify/blob/main/docker/docker-compose.yaml<br>
https://docs.docker.jp/compose/profiles.html<br>

â€»ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ãŒã‚ã‚Šã€profiles ã§ã€qdrant ã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦èµ·å‹•å¯èƒ½
ã€€ç¾åœ¨ã¯ã€Qdrant ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹

```yaml
# Qdrant vector store.
# (if used, you need to set VECTOR_STORE to qdrant in the api & worker service.)
qdrant:
image: langgenius/qdrant:v1.7.3
profiles:
  - qdrant
restart: always
volumes:
  - ./volumes/qdrant:/qdrant/storage
environment:
  QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
```

https://docs.dify.ai/ja-jp/getting-started/readme/features-and-specifications

```bash
git clone https://github.com/langgenius/dify.git
cd dify/docker
cp .env.example .env
docker-compose --profile qdrant up -d # qdrantã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦èµ·å‹•
docker-compose ps
```

ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

```bash
http://localhost/
http://ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹/
```

## ã‚¹ãƒšãƒƒã‚¯ã«ã¤ã„ã¦

EC2 ã® IAMRole ã¯ã€æœ€ä½é™ Bedrock ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãŠãã‚ˆã†ã«
EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¯ã€t3.medium ã§èµ·å‹•å¯èƒ½
EBS ã¯ã€æœ€å°ã§ 7.3GB ä½¿ç”¨ã—ãŸ
Knowledge Base ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã™ã‚‹å ´åˆã¯ã€50 ï½ 100GB ãã‚‰ã„ã‚ã£ã¦ã‚‚è‰¯ã„ã¨æ€ã†

## ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

https://zenn.dev/aidemy/articles/13ceca39b0ea6c<br>
https://langfuse.com/pricing<br>

Langfuse ãŒç„¡æ–™ã§ä½¿ç”¨å¯èƒ½

## Dify è¨­å®šã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³

é©å½“ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹
â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒã‚§ãƒƒã‚¯ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚å•é¡Œãªã„ã§ã™

![](/images/20241003_dify/1.png)
![](/images/20241003_dify/2.png)
![](/images/20241003_dify/3.png)

### Dify è¨­å®š

è¨­å®šç”»é¢ã«ç§»å‹•
![](/images/20241003_dify/4.png)

æ™‚åˆ»è¨­å®š
![](/images/20241003_dify/5.png)

LLM (Bedrock) è¨­å®š
â€»ãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨
![](/images/20241003_dify/7.png)
â€»é©å½“ã« 1 ã¤ãƒ¢ãƒ‡ãƒ« ID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™
![](/images/20241003_dify/8.png)
â€»IAM Role ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼è¨­å®šã¯ä¸è¦ã§ã™
![](/images/20241003_dify/6.png)
![](/images/20241003_dify/9.png)

å„ãƒ¢ãƒ‡ãƒ«è¨­å®š
![](/images/20241003_dify/10.png)
![](/images/20241003_dify/11.png)

### ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆ (å‹•ä½œç¢ºèª)

![](/images/20241003_dify/12.png)
![](/images/20241003_dify/13.png)
â€»ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
![](/images/20241003_dify/14.png)
â€»æ›´æ–°ã™ã‚‹ (ä½•ã‹è¨­å®šå¤‰æ›´ã—ãŸã‚‰æ›´æ–°ã—ã¦ä¿å­˜ã™ã‚‹ã‚ˆã†ã«!)
![](/images/20241003_dify/15.png)

ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’èµ·å‹•
![](/images/20241003_dify/16.png)

ãƒãƒ£ãƒƒãƒˆã—ã¦ã¿ã‚‹
![](/images/20241003_dify/17.png)
![](/images/20241003_dify/18.png)
Claude 3 Haiku ã¯ã€ChatGPT ã‚’ãƒ™ãƒ¼ã‚¹ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸâ€¦

## Langfuse è¨­å®šã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

### Langfuse èµ·å‹•

Dify ã¨åŒæ§˜ã« Docker Compose ã§èµ·å‹•ã™ã‚‹

https://langfuse.com/docs/deployment/local<br>
https://note.com/jolly_dahlia842/n/n406dec2c11d9

```bash
sudo -s
cd
git clone https://github.com/langfuse/langfuse.git
cd langfuse
vi docker-compose.yml
```

ä»¥ä¸‹ã«ä¿®æ­£

1. ãƒãƒ¼ãƒˆ 3000 ã¯ã€Dify ãŒä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€3002 ã«å¤‰æ›´ã™ã‚‹
2. network ã‚’è¿½åŠ ã—ã¦ã€Dify ã¨ Langfuse ã‚’åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é…ç½®ã™ã‚‹

```yaml
services:
  langfuse-server:
    image: langfuse/langfuse:2
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "3002:3000" # å¤‰æ›´
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/postgres
      - NEXTAUTH_SECRET=mysecret
      - SALT=mysalt
      - ENCRYPTION_KEY=0000000000000000000000000000000000000000000000000000000000000000
      - NEXTAUTH_URL=http://localhost:3002 # å¤‰æ›´
      - TELEMETRY_ENABLED=${TELEMETRY_ENABLED:-true}
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-false}
    networks: # è¿½åŠ 
      - langfuse_network # è¿½åŠ 

  db:
    image: postgres
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 3s
      retries: 10
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - 5432:5432
    volumes:
      - database_data:/var/lib/postgresql/data
    networks: # è¿½åŠ 
      - langfuse_network # è¿½åŠ 

volumes:
  database_data:
    driver: local

networks: # è¿½åŠ 
  langfuse_network: # è¿½åŠ 
    name: langfuse_network # è¿½åŠ 
    driver: bridge # è¿½åŠ 
```

```bash
docker-compose up -d
docker-compose ps
docker network ls
```

ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

```bash
http://ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹:3002/
```

Dify ã® docker-compose.yaml ã‚’ä¿®æ­£ã—ã€Langfuse ã¨åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é…ç½®ã™ã‚‹

```bash
cd /root/dify/docker
vi docker-compose.yaml
```

ä»¥ä¸‹ã€2 ã¤ã® api ã¨ worker ã‚µãƒ¼ãƒ“ã‚¹ã« langfuse_network ã‚’è¿½åŠ ã™ã‚‹
â€»vi ã‚¨ãƒ‡ã‚£ã‚¿ã§ã€/api ã¨/worker ã§æ¤œç´¢

```yaml
services:
  api:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: api
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # è¿½åŠ 

  worker:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # è¿½åŠ 
```

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã«ã‚‚è¿½åŠ 
â€»/networks ã§æ¤œç´¢

```yaml
networks:
  ssrf_proxy_network:
    driver: bridge
    internal: true
  milvus:
    driver: bridge
  opensearch-net:
    driver: bridge
    internal: true
  langfuse_network: # è¿½åŠ 
    name: langfuse_network # è¿½åŠ 
    external: true # è¿½åŠ 
```

Dify ã‚’å†èµ·å‹•

```bash
docker-compose down
docker-compose up -d
docker-compose ps
```

### Langfuse ã¨ Dify ã®é€£æº

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
![](/images/20241003_dify/20.png)
![](/images/20241003_dify/21.png)

â€»ãªãœã‹ localhost ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã¨æ€ã£ãŸã‚‰ URL ã‚’ç¢ºèªã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã—ã¦å†æ¥ç¶šã™ã‚‹ã“ã¨

åˆæœŸè¨­å®š
![](/images/20241003_dify/22.png)
![](/images/20241003_dify/23.png)
![](/images/20241003_dify/24.png)
![](/images/20241003_dify/25.png)

API Key ã‚’ä½œæˆã™ã‚‹
![](/images/20241003_dify/26.png)
![](/images/20241003_dify/27.png)

Dify ã®è¨­å®šç”»é¢ã«ç§»å‹•
â€»Host ã¯ã€ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹

```bash
http://langfuse-server:3000
```

![](/images/20241003_dify/19.png)
![](/images/20241003_dify/28.png)
![](/images/20241003_dify/29.png)

ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®å‹•ä½œç¢ºèª
â€»Dify ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’èµ·å‹•ã—ã¦ã€ä½•ã‹è³ªå•ã™ã‚‹
![](/images/20241003_dify/30.png)

Langfuse ã®ç”»é¢ã«ç§»å‹•ã—ã€Trace ã‚’ç¢ºèªã™ã‚‹
![](/images/20241003_dify/31.png)
![](/images/20241003_dify/32.png)

ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚„ Token æ•°ãŒç¢ºèªã§ãã‚‹
![](/images/20241003_dify/33.png)
