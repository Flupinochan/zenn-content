---
title: "Difyå°å…¥ å€‹äººãƒ¡ãƒ¢"
emoji: "ğŸ—‚"
type: "tech"
topics: ["aws", "dify", "bedrock"]
published: true
---

æ€¥ã« RAG ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’å°å…¥ã™ã‚‹ã“ã¨ã«ãªã£ãŸã®ã§â€¦
å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™
å®šæœŸçš„ã«æ›´æ–°ã—ã¾ã™
â€»2024/10/03 æ™‚ç‚¹ã§ã®æƒ…å ±ã§ã™

## Install Docker Compose

https://zenn.dev/rock_penguin/articles/28875c7b0a5e30<br>
https://github.com/docker/compose/releases/<br>

â€»ä»¥ä¸‹ã® v2.29.7 ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64

```bash
sudo -s
cd
dnf update
dnf install -y docker
systemctl start docker
gpasswd -a $(whoami) docker
chgrp docker /var/run/docker.sock
systemctl restart docker
systemctl enable docker
curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

ã€Œuname -sã€ã¯ OS åã€ä¾‹ãˆã°ã€ŒLinuxã€
ã€Œuname -mã€ã¯ CPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ä¾‹ãˆã°ã€Œx86_64ã€<br>

```bash
docker -v
docker-compose -v
```

## Install Git

```bash
dnf install -y git
```

## Install Dify

https://docs.dify.ai/ja-jp/getting-started/install-self-hosted/docker-compose#difyno<br>
https://github.com/langgenius/dify/blob/main/docker/docker-compose.yaml<br>
https://docs.docker.jp/compose/profiles.html<br>

â€»ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ãŒã‚ã‚Šã€profiles ã§ã€qdrant ã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦èµ·å‹•å¯èƒ½
ã€€ç¾åœ¨ã¯ã€Qdrant ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹

```yaml
# Qdrant vector store.
# (if used, you need to set VECTOR_STORE to qdrant in the api & worker service.)
qdrant:
image: langgenius/qdrant:v1.7.3
profiles:
  - qdrant
restart: always
volumes:
  - ./volumes/qdrant:/qdrant/storage
environment:
  QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
```

https://docs.dify.ai/ja-jp/getting-started/readme/features-and-specifications

```bash
git clone https://github.com/langgenius/dify.git
cd dify/docker
cp .env.example .env
docker-compose --profile qdrant up -d # qdrantã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦èµ·å‹•
docker-compose ps
```

ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

```bash
http://localhost/
http://ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹/
```

## ã‚¹ãƒšãƒƒã‚¯ã«ã¤ã„ã¦

EC2 ã® IAMRole ã¯ã€æœ€ä½é™ Bedrock ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãŠãã‚ˆã†ã«
EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¯ã€t3.medium ã§èµ·å‹•å¯èƒ½
EBS ã¯ã€æœ€å°ã§ 7.3GB ä½¿ç”¨ã—ãŸ
Knowledge Base ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã™ã‚‹å ´åˆã¯ã€50 ï½ 100GB ãã‚‰ã„ã‚ã£ã¦ã‚‚è‰¯ã„ã¨æ€ã†

## ãƒ­ã‚°ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°

https://zenn.dev/aidemy/articles/13ceca39b0ea6c<br>
https://langfuse.com/pricing<br>

Langfuse ãŒç„¡æ–™ã§ä½¿ç”¨å¯èƒ½

## Dify è¨­å®šã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

### ã‚µã‚¤ãƒ³ã‚¤ãƒ³

é©å½“ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹
â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒã‚§ãƒƒã‚¯ã¯è¡Œã‚ã‚Œãªã„ãŸã‚ã€å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚å•é¡Œãªã„ã§ã™

![](/images/20241003_dify/1.png)
![](/images/20241003_dify/2.png)
![](/images/20241003_dify/3.png)

### Dify è¨­å®š

è¨­å®šç”»é¢ã«ç§»å‹•
![](/images/20241003_dify/4.png)

æ™‚åˆ»è¨­å®š
![](/images/20241003_dify/5.png)

LLM (Bedrock) è¨­å®š
â€»ãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æœ‰åŠ¹ã§ã‚ã‚‹ã“ã¨
![](/images/20241003_dify/7.png)
â€»é©å½“ã« 1 ã¤ãƒ¢ãƒ‡ãƒ« ID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™
![](/images/20241003_dify/8.png)
â€»IAM Role ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼è¨­å®šã¯ä¸è¦ã§ã™
![](/images/20241003_dify/6.png)
![](/images/20241003_dify/9.png)

å„ãƒ¢ãƒ‡ãƒ«è¨­å®š
![](/images/20241003_dify/10.png)
![](/images/20241003_dify/11.png)

### ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆ (å‹•ä½œç¢ºèª)

![](/images/20241003_dify/12.png)
![](/images/20241003_dify/13.png)
â€»ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
![](/images/20241003_dify/14.png)
â€»æ›´æ–°ã™ã‚‹ (ä½•ã‹è¨­å®šå¤‰æ›´ã—ãŸã‚‰æ›´æ–°ã—ã¦ä¿å­˜ã™ã‚‹ã‚ˆã†ã«!)
![](/images/20241003_dify/15.png)

ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’èµ·å‹•
![](/images/20241003_dify/16.png)

ãƒãƒ£ãƒƒãƒˆã—ã¦ã¿ã‚‹
![](/images/20241003_dify/17.png)
![](/images/20241003_dify/18.png)
Claude 3 Haiku ã¯ã€ChatGPT ã‚’ãƒ™ãƒ¼ã‚¹ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸâ€¦

## Langfuse è¨­å®šã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

### Langfuse èµ·å‹•

Dify ã¨åŒæ§˜ã« Docker Compose ã§èµ·å‹•ã™ã‚‹

https://langfuse.com/docs/deployment/local<br>
https://note.com/jolly_dahlia842/n/n406dec2c11d9

```bash
sudo -s
cd
git clone https://github.com/langfuse/langfuse.git
cd langfuse
vi docker-compose.yml
```

ä»¥ä¸‹ã«ä¿®æ­£

1. ãƒãƒ¼ãƒˆ 3000 ã¯ã€Dify ãŒä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€3002 ã«å¤‰æ›´ã™ã‚‹
2. network ã‚’è¿½åŠ ã—ã¦ã€Dify ã¨ Langfuse ã‚’åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é…ç½®ã™ã‚‹

```yaml
services:
  langfuse-server:
    image: langfuse/langfuse:2
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "3002:3000" # å¤‰æ›´
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/postgres
      - NEXTAUTH_SECRET=mysecret
      - SALT=mysalt
      - ENCRYPTION_KEY=0000000000000000000000000000000000000000000000000000000000000000
      - NEXTAUTH_URL=http://localhost:3002 # å¤‰æ›´
      - TELEMETRY_ENABLED=${TELEMETRY_ENABLED:-true}
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-false}
    networks: # è¿½åŠ 
      - langfuse_network # è¿½åŠ 

  db:
    image: postgres
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 3s
      retries: 10
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - 5432:5432
    volumes:
      - database_data:/var/lib/postgresql/data
    networks: # è¿½åŠ 
      - langfuse_network # è¿½åŠ 

volumes:
  database_data:
    driver: local

networks: # è¿½åŠ 
  langfuse_network: # è¿½åŠ 
    name: langfuse_network # è¿½åŠ 
    driver: bridge # è¿½åŠ 
```

```bash
docker-compose up -d
docker-compose ps
docker network ls
```

ä»¥ä¸‹ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

```bash
http://ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹:3002/
```

Dify ã® docker-compose.yaml ã‚’ä¿®æ­£ã—ã€Langfuse ã¨åŒã˜ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é…ç½®ã™ã‚‹

```bash
cd /root/dify/docker
vi docker-compose.yaml
```

ä»¥ä¸‹ã€2 ã¤ã® api ã¨ worker ã‚µãƒ¼ãƒ“ã‚¹ã« langfuse_network ã‚’è¿½åŠ ã™ã‚‹
â€»vi ã‚¨ãƒ‡ã‚£ã‚¿ã§ã€/api ã¨/worker ã§æ¤œç´¢

```yaml
services:
  api:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: api
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # è¿½åŠ 

  worker:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # è¿½åŠ 
```

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã«ã‚‚è¿½åŠ 
â€»/networks ã§æ¤œç´¢

```yaml
networks:
  ssrf_proxy_network:
    driver: bridge
    internal: true
  milvus:
    driver: bridge
  opensearch-net:
    driver: bridge
    internal: true
  langfuse_network: # è¿½åŠ 
    name: langfuse_network # è¿½åŠ 
    external: true # è¿½åŠ 
```

Dify ã‚’å†èµ·å‹•

```bash
docker-compose down
docker-compose up -d
docker-compose ps
```

### Langfuse ã¨ Dify ã®é€£æº

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
![](/images/20241003_dify/20.png)
![](/images/20241003_dify/21.png)

â€»ãªãœã‹ localhost ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã¨æ€ã£ãŸã‚‰ URL ã‚’ç¢ºèªã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ« IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æˆ»ã—ã¦å†æ¥ç¶šã™ã‚‹ã“ã¨

åˆæœŸè¨­å®š
![](/images/20241003_dify/22.png)
![](/images/20241003_dify/23.png)
![](/images/20241003_dify/24.png)
![](/images/20241003_dify/25.png)

API Key ã‚’ä½œæˆã™ã‚‹
![](/images/20241003_dify/26.png)
![](/images/20241003_dify/27.png)

Dify ã®è¨­å®šç”»é¢ã«ç§»å‹•
â€»Host ã¯ã€ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹

```bash
http://langfuse-server:3000
```

![](/images/20241003_dify/19.png)
![](/images/20241003_dify/28.png)
![](/images/20241003_dify/29.png)

ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®å‹•ä½œç¢ºèª
â€»Dify ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’èµ·å‹•ã—ã¦ã€ä½•ã‹è³ªå•ã™ã‚‹
![](/images/20241003_dify/30.png)

Langfuse ã®ç”»é¢ã«ç§»å‹•ã—ã€Trace ã‚’ç¢ºèªã™ã‚‹
![](/images/20241003_dify/31.png)
![](/images/20241003_dify/32.png)

ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚„ Token æ•°ãŒç¢ºèªã§ãã‚‹
![](/images/20241003_dify/33.png)

## Dify ã¨ Bedrock Knowledge Base ã®é€£æºã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

- Dify ã«ã¯ã€Knowledge Base ã®æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã™ãŒã€Confluence ã‚„ SharePoint ã‚’ã‚½ãƒ¼ã‚¹ã«ã¯ã§ãã¾ã›ã‚“
- ãã®ãŸã‚ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã®æ©Ÿèƒ½ã§ã€Bedrock Knowledge Base ã¨é€£æºã—ã¾ã™
- ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã§ã€REST API (POST ãƒ¡ã‚½ãƒƒãƒ‰) ã‚’ä½¿ç”¨ã—ã€API Gateway (Lambda) ã‚’çµŒç”±ã—ã¦ Bedrock Knowledge Base ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™
- Bedrock Knowledge Base ã¯ã€Confluence ã‚„ SharePoint ã‚’ã‚½ãƒ¼ã‚¹ã«ã§ãã¾ã™

https://docs.aws.amazon.com/ja_jp/bedrock/latest/userguide/data-source-connectors.html

### Bedrock Knowledge Base ã‚’æ§‹ç¯‰

ä»¥ä¸‹ã® CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€Bedrock Knowledge Base ã‚’æ§‹ç¯‰ã—ã¾ã™

- S3 ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ã™ã‚‹
- Aurora Serverless ã‚’ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹

â€»Bedrock Knowledge Base ã¸ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’ã—ãŸã„ãŸã‚ã€ã“ã“ã§ã¯ SharePoint ã§ã¯ãªã S3 ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ã—ã¾ã™

https://dev.classmethod.jp/articles/cloudformation-knowledge-base-for-bedrock-with-aurora/

```yaml
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network
        Parameters:
          - VPCName
          - PrivateSubnetName1A
          - PrivateSubnetName1C
          - PrivateSubnetRegion1A
          - PrivateSubnetRegion1C
          - PrivateSubnetRouteTableName
      - Label:
          default: Aurora
        Parameters:
          - AuroraSecurityGroupName
          - AuroraSubnetGroupName
          - AuroraName
          - DBUserName
      - Label:
          default: SecretsManager
        Parameters:
          - SecretsManagerName
          - DBBedrockUser
          - DBBedrockPassword
      - Label:
          default: S3
        Parameters:
          - S3Name
          - S3LambdaName
          - S3IAMRoleName
          - S3IAMPolicyName
          - S3CloudWatchLogsName
      - Label:
          default: Lambda
        Parameters:
          - ExecSQLLambdaRoleName
          - ExecSQLLambdaeName
      - Label:
          default: KnowledgeBase
        Parameters:
          - KnowledgeBaseIAMRoleName
          - KnowledgeBaseIAMPolicyName
          - KnowledgeBaseName
          - KnowledgeBaseEmbeddingModel
          - KnowledgeBaseDataSourceName

Parameters:
  VPCName:
    Type: String
    Default: "KnowledgeBase-VPC"
  PrivateSubnetName1A:
    Type: String
    Default: "KnowledgeBase-PrivateSubnet1A"
  PrivateSubnetName1C:
    Type: String
    Default: "KnowledgeBase-PrivateSubnet1C"
  PrivateSubnetRegion1A:
    Type: String
    Default: "ap-northeast-1a"
  PrivateSubnetRegion1C:
    Type: String
    Default: "ap-northeast-1c"
  PrivateSubnetRouteTableName:
    Type: String
    Default: "KnowledgeBase-PrivateSubnetRouteTable"

  AuroraSubnetGroupName:
    Type: String
    Default: "KnowledgeBase-AuroraSubnetGroup"
  AuroraSecurityGroupName:
    Type: String
    Default: "KnowledgeBase-AuroraSecurityGroup"
  AuroraName:
    Type: String
    Default: "knowledgebase"
  DBUserName:
    Type: String
    Default: "postgresql"

  SecretsManagerName:
    Type: String
    Default: "knowledge-base"
  DBBedrockUser:
    Type: String
    Default: "bedrock_user"
  DBBedrockPassword:
    Type: String
    Default: "bedrock_password"

  S3Name:
    Type: String
    Default: "knowledgebase-datasource"
  S3LambdaName:
    Type: String
    Default: "delete-knowledgebase-datasource"
  S3IAMRoleName:
    Type: String
    Default: "delete-knowledgebase-datasource"
  S3IAMPolicyName:
    Type: String
    Default: "delete-knowledgebase-datasource"
  S3CloudWatchLogsName:
    Type: String
    Default: "delete-knowledgebase-datasource"

  ExecSQLLambdaRoleName:
    Type: String
    Default: "KnowledgeBase-ExecSQLLambda-Role"
  ExecSQLLambdaeName:
    Type: String
    Default: "KnowledgeBase-ExecSQLLambda"

  KnowledgeBaseIAMRoleName:
    Type: String
    Default: "KnowledgeBase-IAMRole"
  KnowledgeBaseIAMPolicyName:
    Type: String
    Default: "KnowledgeBase-IAMPolicy"
  KnowledgeBaseName:
    Type: String
    Default: "KnowledgeBase"
  KnowledgeBaseEmbeddingModel:
    Type: String
    Default: "amazon.titan-embed-text-v1"
  KnowledgeBaseDataSourceName:
    Type: String
    Default: "KnowledgeBaseDataSource"

Resources:
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: "Name"
          Value: !Ref VPCName
  PrivateSubnet1A:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.1.0/24"
      AvailabilityZone: !Ref PrivateSubnetRegion1A
      MapPublicIpOnLaunch: false
      Tags:
        - Key: "Name"
          Value: !Ref PrivateSubnetName1A
  PrivateSubnet1C:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      CidrBlock: "10.0.2.0/24"
      AvailabilityZone: !Ref PrivateSubnetRegion1C
      MapPublicIpOnLaunch: false
      Tags:
        - Key: "Name"
          Value: !Ref PrivateSubnetName1C
  PrivateSubnetRouteTable:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "Name"
          Value: !Ref PrivateSubnetRouteTableName
  PrivateSubnetRouteTableAssociation1A:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref PrivateSubnet1A
      RouteTableId: !Ref PrivateSubnetRouteTable
  PrivateSubnetRouteTableAssociation1C:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      SubnetId: !Ref PrivateSubnet1C
      RouteTableId: !Ref PrivateSubnetRouteTable

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Ref AuroraSecurityGroupName
      GroupDescription: Allow all traffic from self
      VpcId: !GetAtt VPC.VpcId
  DBSubnetGroup:
    Type: "AWS::RDS::DBSubnetGroup"
    Properties:
      DBSubnetGroupName: !Ref AuroraSubnetGroupName
      DBSubnetGroupDescription: Bedrock Aurora Subnet Group # required description
      SubnetIds:
        - !GetAtt PrivateSubnet1A.SubnetId
        - !GetAtt PrivateSubnet1C.SubnetId
  AuroraCluster:
    Type: "AWS::RDS::DBCluster"
    DeletionPolicy: Delete
    Properties:
      Engine: "aurora-postgresql"
      EngineVersion: "15.6" # https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/aurora-serverless-v2.requirements.html#aurora-serverless-v2-Availability
      DBClusterIdentifier: "aurora-cluster"
      DatabaseName: !Ref AuroraName
      MasterUsername: !Ref DBUserName
      ManageMasterUserPassword: true
      StorageType: "aurora"
      ServerlessV2ScalingConfiguration:
        MinCapacity: 0.5
        MaxCapacity: 1.0
      VpcSecurityGroupIds:
        - !GetAtt DBSecurityGroup.GroupId
      DBSubnetGroupName: !Ref DBSubnetGroup
      AvailabilityZones:
        - !Ref PrivateSubnetRegion1A
        - !Ref PrivateSubnetRegion1C
      BackupRetentionPeriod: "7"
      DeletionProtection: False
      StorageEncrypted: False
      EnableHttpEndpoint: true # boto3.client('rds-data') ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«å¿…è¦
  AuroraInstance:
    Type: "AWS::RDS::DBInstance"
    Properties:
      Engine: "aurora-postgresql"
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceIdentifier: "aurora-instance"
      DBInstanceClass: "db.serverless"
      PubliclyAccessible: False
      EnablePerformanceInsights: False
      MonitoringInterval: "0"

  SecretsManager:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Ref SecretsManagerName
      Description: "Secret for the database user for Bedrock"
      SecretString: !Sub '{ "username":"${DBBedrockUser}", "password":"${DBBedrockPassword}"}'

  S3:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${S3Name}-${AWS::AccountId}"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: FALSE
      VersioningConfiguration:
        Status: "Suspended"
      LifecycleConfiguration:
        Rules:
          - Id: "rule1"
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
            Status: "Enabled"
      CorsConfiguration:
        CorsRules:
          - Id: corsRule1
            MaxAge: 0
            AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - POST
            AllowedOrigins:
              - "https://www.metalmental.net"
  S3Lambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref S3LambdaName
      Handler: index.lambda_handler
      Role: !GetAtt S3IAMRole.Arn
      Runtime: python3.12
      Timeout: 300
      LoggingConfig:
        LogGroup: !Ref S3CloudWatchLogs
      Code:
        ZipFile: |
          import boto3
          import cfnresponse
          def lambda_handler(event, context):
              s3 = boto3.resource('s3')
              try:
                  if event['RequestType'] == 'Delete':
                      bucket = s3.Bucket(event['ResourceProperties']['BucketName'])
                      bucket.objects.all().delete()
                      bucket.object_versions.all().delete()
                      s3.Bucket(event['ResourceProperties']['BucketName']).delete()
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print("Error: ", e)
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})
  S3LambdaInvoke:
    Type: Custom::EmptyS3Bucket
    Properties:
      ServiceToken: !GetAtt S3Lambda.Arn
      BucketName: !Ref S3
  S3IAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref S3IAMRoleName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonRDSDataFullAccess"
      Policies:
        - PolicyName: !Ref S3IAMPolicyName
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !Sub ${S3.Arn}
                  - !Sub ${S3.Arn}/*
              - Effect: Allow
                Action:
                  - logs:*
                Resource:
                  - !Sub ${S3CloudWatchLogs.Arn}
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Sub ${AuroraCluster.MasterUserSecret.SecretArn}
  S3CloudWatchLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Ref S3CloudWatchLogsName
      RetentionInDays: 1

  SetupAuroraData:
    Type: "Custom::SetupAuroraData"
    DependsOn: AuroraInstance
    Properties:
      ServiceToken: !GetAtt ExecSQLLambda.Arn
      ClusterArn: !GetAtt AuroraCluster.DBClusterArn
      SecretArn: !GetAtt AuroraCluster.MasterUserSecret.SecretArn
      DatabaseName: !Ref AuroraName
      DatabasePassword: !Ref DBBedrockPassword
      UserName: !Ref DBBedrockUser
  ExecSQLLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref ExecSQLLambdaeName
      Handler: index.lambda_handler
      Role: !GetAtt S3IAMRole.Arn
      Runtime: python3.12
      Timeout: 900
      LoggingConfig:
        LogGroup: !Ref S3CloudWatchLogs
      Code:
        ZipFile: |
          import boto3
          import cfnresponse

          rds_data = boto3.client('rds-data')

          def execute_statement(cluster_arn, database_name, secret_arn, sql):
              response = rds_data.execute_statement(
                  resourceArn=cluster_arn,
                  database=database_name,
                  secretArn=secret_arn,
                  sql=sql
              )
              return response

          def lambda_handler(event, context):
              try:
                  cluster_arn = event['ResourceProperties']['ClusterArn']
                  secret_arn = event['ResourceProperties']['SecretArn']
                  database_name = event['ResourceProperties']['DatabaseName']
                  database_password = event['ResourceProperties']['DatabasePassword']
                  user_name = event['ResourceProperties']['UserName']
                  print(f"cluster_arn: {cluster_arn}")
                  print(f"secret_arn: {secret_arn}")
                  print(f"database_name: {database_name}")
                  print(f"database_password: {database_password}")
                  print(f"user_name: {user_name}")

                  if event['RequestType'] == 'Create':
                      print("Setup Aurora")
                      # https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.VectorDB.html#AuroraPostgreSQL.VectorDB.PreparingKB
                      # 4
                      create_extension = f"CREATE EXTENSION IF NOT EXISTS vector;"
                      execute_statement(cluster_arn, database_name, secret_arn, create_extension)

                      check_pg_vector = f"SELECT extversion FROM pg_extension WHERE extname='vector';"
                      execute_statement(cluster_arn, database_name, secret_arn, check_pg_vector)

                      # 5
                      create_schema = f"CREATE SCHEMA bedrock_integration;"
                      execute_statement(cluster_arn, database_name, secret_arn, create_schema)

                      # 6
                      create_role = f"CREATE ROLE {user_name} WITH PASSWORD '{database_password}' LOGIN;"
                      execute_statement(cluster_arn, database_name, secret_arn, create_role)

                      # 7
                      grant_schema = f"GRANT ALL ON SCHEMA bedrock_integration to {user_name};"
                      execute_statement(cluster_arn, database_name, secret_arn, grant_schema)

                      # 8
                      create_table = f"CREATE TABLE bedrock_integration.bedrock_kb (id uuid PRIMARY KEY, embedding vector(1536), chunks text, metadata json)"
                      execute_statement(cluster_arn, database_name, secret_arn, create_table)

                      # require
                      grant_table = f"GRANT ALL ON TABLE bedrock_integration.bedrock_kb TO {user_name};"
                      execute_statement(cluster_arn, database_name, secret_arn, grant_table)

                      # 9
                      create_index = f"CREATE INDEX on bedrock_integration.bedrock_kb USING hnsw (embedding vector_cosine_ops);"
                      execute_statement(cluster_arn, database_name, secret_arn, create_index)

                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Message': str(e)})

  KnowledgeBaseIAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref KnowledgeBaseIAMRoleName
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "sts:AssumeRole"
            Principal:
              Service:
                - bedrock.amazonaws.com
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonRDSDataFullAccess"
      Policies:
        - PolicyName: !Ref KnowledgeBaseIAMPolicyName
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "bedrock:InvokeModel"
                Resource:
                  - "*"
              - Effect: Allow
                Action:
                  - s3:*
                Resource:
                  - !Sub ${S3.Arn}
                  - !Sub ${S3.Arn}/*
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref SecretsManager
              - Effect: Allow
                Action:
                  - rds:*
                Resource:
                  - !Sub ${AuroraCluster.DBClusterArn}
  BedrockKnowledgeBase:
    Type: AWS::Bedrock::KnowledgeBase
    Properties:
      Name: !Ref KnowledgeBaseName
      RoleArn: !GetAtt KnowledgeBaseIAMRole.Arn
      KnowledgeBaseConfiguration:
        Type: VECTOR
        VectorKnowledgeBaseConfiguration:
          EmbeddingModelArn: !Sub
            - "arn:${AWS::Partition}:bedrock:${AWS::Region}::foundation-model/${Model}"
            - Model: !Ref KnowledgeBaseEmbeddingModel
      StorageConfiguration:
        Type: RDS
        RdsConfiguration:
          CredentialsSecretArn: !Ref SecretsManager
          DatabaseName: !Ref AuroraName
          FieldMapping:
            PrimaryKeyField: "id"
            VectorField: "embedding"
            TextField: "chunks"
            MetadataField: "metadata"
          ResourceArn: !GetAtt AuroraCluster.DBClusterArn
          TableName: "bedrock_integration.bedrock_kb"
    DependsOn: SetupAuroraData
  KnowledgeBaseDataSource:
    Type: AWS::Bedrock::DataSource
    Properties:
      KnowledgeBaseId: !Ref BedrockKnowledgeBase
      Name: !Ref KnowledgeBaseDataSourceName
      DataSourceConfiguration:
        Type: S3
        S3Configuration:
          BucketArn: !GetAtt S3.Arn
```

![](/images/20241003_dify/34.png)

### S3 ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´

Knowledge Base ã¨ã—ã¦èª­ã¿è¾¼ã¾ã›ãŸã„é©å½“ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ S3 ã«æ ¼ç´ã—ã¾ã™

â€»å¯¾å¿œã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã‹ã‚‰ã”ç¢ºèªãã ã•ã„
https://docs.aws.amazon.com/ja_jp/bedrock/latest/userguide/knowledge-base-ds.html

ç§ã¯ã€æœ€æ–°ã®ä»¥ä¸‹ 3 ã¤ã®è¨˜äº‹ã‚’ html ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€S3 ã«æ ¼ç´ã—ã¾ã—ãŸ
AWS Chatbot ã¨ Bedrock Knowledge Base (Agent) ãŒé€£æºã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã€ã¨ã„ã†å†…å®¹ã§ã€ç”Ÿæˆ AI ãŒçŸ¥ã‚‰ãªã„æƒ…å ±ã§ã™

https://aws.amazon.com/jp/about-aws/whats-new/2024/09/aws-chatbot-amazon-bedrock-agent-microsoft-teams-slack/
https://qiita.com/moritalous/items/b63d976c2c40af1c39e5
https://qiita.com/minorun365/items/3d6bb63a59fb10712948

S3 ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
![](/images/20241003_dify/35.png)
![](/images/20241003_dify/36.png)
![](/images/20241003_dify/37.png)

Bedrock Knowledge Base ã§ Sync ã—ã¾ã™
![](/images/20241003_dify/38.png)
![](/images/20241003_dify/39.png)
![](/images/20241003_dify/40.png)

ãƒ†ã‚¹ãƒˆã—ã¾ã™
ã€Œbedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹ã€ã¨è³ªå•ã—ã¾ã™
![](/images/20241003_dify/41.png)
å•é¡Œãªã Knowledge Base ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸ

### Lambda ã‚’ä½œæˆ

https://acro-engineer.hatenablog.com/entry/2024/07/22/120000

1. Lambda ã‚’ä½œæˆ
   å…ˆã»ã©ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ†ã‚¹ãƒˆã—ãŸã“ã¨ã¨åŒæ§˜ãªã“ã¨ã‚’ã€ã‚³ãƒ¼ãƒ‰ã§ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
   Python Boto3 ã‚’ä½¿ç”¨ã—ã¦ã€Bedrock Knowledge Base ã«è³ªå•ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
   <br>
2. API Gateway ã‚’ä½œæˆ
   REST API (POST ãƒ¡ã‚½ãƒƒãƒ‰) ã‚’ä½œæˆã—ã€1 ã§ä½œæˆã—ãŸ Lambda ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™
   <br>
3. Dify ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã—ã€2 ã§ä½œæˆã—ãŸ API Gateway ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™
   <br>

Lambda ã‚’ä½œæˆã—ã¾ã™
![](/images/20241003_dify/42.png)
![](/images/20241003_dify/43.png)

ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ 30 ç§’ã«ã—ã¾ã™
â€»API Gateway ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ 29 ç§’ã®ãŸã‚ã§ã™
![](/images/20241003_dify/48.png)
![](/images/20241003_dify/49.png)

ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™
![](/images/20241003_dify/50.png)

ä»¥ä¸‹ 2 ã¤ã‚’è¨­å®šã—ã¾ã™

| ã‚­ãƒ¼              | å€¤                                                                                      |
| ----------------- | --------------------------------------------------------------------------------------- |
| KNOWLEDGE_BASE_ID | xxxxxxxx                                                                                |
| MODEL_ARN         | arn:aws:bedrock:ap-northeast-1::foundation-model/anthropic.claude-3-haiku-20240307-v1:0 |

![](/images/20241003_dify/54.png)

â€»`KNOWLEDGE_BASE_ID`ã®ç¢ºèªæ–¹æ³•
![](/images/20241003_dify/51.png)
![](/images/20241003_dify/52.png)

â€»`MODEL_ARN`ã®ç¢ºèªæ–¹æ³• (ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã® Claude 3 Haiku ã‚’ä½¿ç”¨ã—ã¾ã™)
![](/images/20241003_dify/55.png)

Lambda ã® IAM Role ã«ã€Bedrock ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¿½åŠ ã—ã¾ã™
![](/images/20241003_dify/44.png)
![](/images/20241003_dify/45.png)

ä»¥ä¸‹ã® IAM Policy ã‚’è¿½åŠ ã—ã¾ã™

```bash
AmazonBedrockFullAccess
```

![](/images/20241003_dify/46.png)
![](/images/20241003_dify/47.png)

Lambda ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™

```python
import os
import boto3
from botocore.config import Config

### Lambdaç’°å¢ƒå¤‰æ•°ã®å–å¾—
try:
    KNOWLEDGE_BASE_ID = os.environ["KNOWLEDGE_BASE_ID"]
    MODEL_ARN = os.environ["MODEL_ARN"]
    # "arn:aws:bedrock:{region}::foundation-model/" + MODEL_ID
except KeyError:
    raise Exception("Environment variable is not defined.")

### Bedrock Agent Runtime ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å–å¾—
try:
    config = Config(
        retries={"max_attempts": 30, "mode": "standard"},
        read_timeout=900,
        connect_timeout=900,
    )
    bedrock_agent_runtime_client = boto3.client("bedrock-agent-runtime", config=config)
except Exception as error:
    raise Exception("Boto3 client error" + str(error))

### Bedrock Knowledge Base ã«è³ªå•ã™ã‚‹
def ask_knowledge_base(event):
    try:
        query = event["query"]
        print(query)
        # ã€ŒnumberOfResultsã€ ã§ã€Knowledge Base ã‹ã‚‰ã„ãã¤ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹ã‹ã‚’æŒ‡å®šã§ãã‚‹
        response = bedrock_agent_runtime_client.retrieve_and_generate(
            input={
                "text": query,
            },
            retrieveAndGenerateConfiguration={
                "type": "KNOWLEDGE_BASE",
                "knowledgeBaseConfiguration": {
                    "knowledgeBaseId": KNOWLEDGE_BASE_ID,
                    "modelArn": MODEL_ARN,
                    "retrievalConfiguration": {
                        "vectorSearchConfiguration": {
                            "numberOfResults": 3,
                        },
                    },
                },
            },
        )
        print(response)
        # å–å¾—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’çµåˆã—ã¦ã€1 ã¤ã®æ–‡å­—åˆ—ã«ã™ã‚‹
        combined_text = '\n'.join(ref['content']['text'] for citation in response['citations'] for ref in citation['retrievedReferences'])
        print(combined_text)
        return combined_text
    except Exception as e:
        print(f"An error occurred: {e}")
        raise

def lambda_handler(event, context):
    try:
        print(event)
        combined_text = ask_knowledge_base(event)
        return combined_text
    except Exception as e:
        print(f"An error occurred: {e}")
        raise
```

![](/images/20241003_dify/56.png)

ãƒ†ã‚¹ãƒˆã—ã¾ã™
ã€Œbedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹ã€ã¨è³ªå•ã—ã¾ã™

```json
{
  "query": "bedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹"
}
```

![](/images/20241003_dify/57.png)
![](/images/20241003_dify/58.png)

ã“ã‚Œã§ Lambda ã®è¨­å®šã¯å®Œäº†ã§ã™

### API Gateway ã‚’ä½œæˆ

https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-gateway-create-usage-plans.html
https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/api-key-usage-plan-oas.html

![](/images/20241003_dify/59.png)
![](/images/20241003_dify/60.png)
POST ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã¾ã™
![](/images/20241003_dify/61.png)
![](/images/20241003_dify/62.png)

â€»Lambda ã® ARN ã¯ä»¥ä¸‹ã§ç¢ºèªã§ãã¾ã™
![](/images/20241003_dify/63.png)

ãƒ†ã‚¹ãƒˆã—ã¾ã™

```json
{
  "query": "bedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹"
}
```

![](/images/20241003_dify/64.png)

POST ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãŠã„ã¦ã€API ã‚­ãƒ¼ã®è¨­å®šã‚’å¿…é ˆã«ã—ã¾ã™
![](/images/20241003_dify/65.png)
![](/images/20241003_dify/66.png)

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™
![](/images/20241003_dify/67.png)
![](/images/20241003_dify/68.png)

API ã‚­ãƒ¼ã‚’ä½œæˆã—ã¾ã™
![](/images/20241003_dify/69.png)
![](/images/20241003_dify/70.png)

ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã—ã¾ã™
![](/images/20241003_dify/71.png)
![](/images/20241003_dify/72.png)

ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é–¢é€£ä»˜ã‘ã¾ã™
![](/images/20241003_dify/73.png)
![](/images/20241003_dify/74.png)
![](/images/20241003_dify/75.png)

ä½¿ç”¨é‡ãƒ—ãƒ©ãƒ³ã¨ API ã‚­ãƒ¼ã‚’é–¢é€£ä»˜ã‘ã¾ã™
![](/images/20241003_dify/76.png)
![](/images/20241003_dify/77.png)

API ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™
![](/images/20241003_dify/78.png)
![](/images/20241003_dify/79.png)

ã“ã‚Œã§ API Gateway ã®è¨­å®šã¯å®Œäº†ã§ã™

Postman ã§ãƒ†ã‚¹ãƒˆã—ã¾ã™
â€»ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚å•é¡Œãªã„ã§ã™

Headers ã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¾ã™

| Key       | Value    |
| --------- | -------- |
| x-api-key | xxxxxxxx |

![](/images/20241003_dify/84.png)

Body ã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ã€Send ã—ã¾ã™
![](/images/20241003_dify/81.png)

```json
{
  "query": "bedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹"
}
```

â€»API ã‚­ãƒ¼ã®ç¢ºèªæ–¹æ³•
![](/images/20241003_dify/82.png)

â€»ãƒªã‚¯ã‚¨ã‚¹ãƒˆ URL ã®ç¢ºèªæ–¹æ³•
![](/images/20241003_dify/83.png)

### Dify ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆ

![](/images/20241003_dify/85.png)

ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸ OpenAPI ã‚¹ã‚­ãƒ¼ãƒã‚’ä¿®æ­£ã—ã¦å…¥åŠ›ã—ã¾ã™

```yaml
openapi: "3.0.1"
info:
  title: "DifyAPI"
  version: "2024-10-04T04:37:52Z"
servers:
  - url: "https://idocl2ul73.execute-api.ap-northeast-1.amazonaws.com/prod" # ã“ã“ã‚’æ­£ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLã«å¤‰æ›´ã™ã‚‹
    variables:
      basePath:
        default: "prod"
paths:
  /:
    post:
      summary: QueryBedrockKnowledgeBase # è¿½åŠ 
      operationId: queryBedrockKnowledgeBase # è¿½åŠ 
      requestBody: # ä»¥ä¸‹ã® requestBody ã‚’è¿½åŠ 
        description: "Request body containing the query"
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/query"
      responses:
        "200":
          description: "200 response"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Empty"
      security:
        - api_key: []
components:
  schemas:
    query: # ä»¥ä¸‹ã® query ã‚’è¿½åŠ 
      title: "query"
      type: "object"
      properties:
        query:
          type: "string"
      required:
        - query
    Empty:
      title: "Empty Schema"
      type: "object"
  securitySchemes:
    api_key:
      type: "apiKey"
      name: "x-api-key"
      in: "header"
```

![](/images/20241003_dify/87.png)

èªè¨¼æ–¹æ³•ã« API Key ã‚’è¨­å®šã—ã¾ã™
| Key | Value |
| --------- | -------- |
| x-api-key | xxxxxxxx |

![](/images/20241003_dify/88.png)

ãƒ†ã‚¹ãƒˆã—ã¾ã™
![](/images/20241003_dify/89.png)

```text
bedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹
```

![](/images/20241003_dify/90.png)

ä¿å­˜ã—ã¾ã™
![](/images/20241003_dify/91.png)

### Knowledge Base ã‚’ä½¿ç”¨ã—ãŸãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½œæˆ

![](/images/20241003_dify/92.png)
![](/images/20241003_dify/93.png)

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã«ã—ã¾ã™
![](/images/20241003_dify/94.png)

#### å‰æçŸ¥è­˜

`/`ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€ä½¿ç”¨ã§ãã‚‹å¤‰æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

![](/images/20241003_dify/98.png)

å³ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã“ã¨ã§`ãƒ–ãƒ­ãƒƒã‚¯`ã‚’è¿½åŠ ã§ãã¾ã™
![](/images/20241003_dify/99.png)
![](/images/20241003_dify/100.png)

#### é–‹å§‹ãƒ–ãƒ­ãƒƒã‚¯

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å•é¡Œãªã„ã§ã™
`sys.query`å¤‰æ•°ã«ãƒ¦ãƒ¼ã‚¶ã®è³ªå•å†…å®¹ãŒå…¥ã‚Šã¾ã™
å¤‰æ•°ã¯ã€å…¨ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰åˆ©ç”¨ã§ãã¾ã™
![](/images/20241003_dify/95.png)

#### è³ªå•åˆ†é¡å™¨ãƒ–ãƒ­ãƒƒã‚¯

å…¥åŠ›å¤‰æ•°ã¯ã€`sys.query`ã«ã—ã¾ã™
`ã‚¯ãƒ©ã‚¹`ã§ã€æ¡ä»¶ã‚’æ—¥æœ¬èªã§è¨˜è¼‰ã—ã¾ã™
ãƒ¦ãƒ¼ã‚¶ã®è³ªå•ã«å¯¾ã—ã¦ã€è‡ªç„¶è¨€èªã§ IF æ–‡ã‚’å®šç¾©ã™ã‚‹ã¨è€ƒãˆã¦ãã ã•ã„

![](/images/20241003_dify/96.png)

#### å›ç­” 2 ãƒ–ãƒ­ãƒƒã‚¯

å›ç­”ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€ãƒ¦ãƒ¼ã‚¶ã®è³ªå•ã«å¯¾ã—ã¦å›ç­”ã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡ã‚’è¨˜è¼‰ã—ã¾ã™
ã“ã“ã§ã¯ã€Knowledge Base ã‹ã‚‰æƒ…å ±ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã«ãªã‚‹ã®ã§ã€ä»¥ä¸‹ã®æ—¥æœ¬èªã‚’ç›´æ¥è¿”ã—ã¾ã™

```text
Knowledge Baseã«æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ
```

![](/images/20241003_dify/97.png)

#### ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯

ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ãƒ–ãƒ­ãƒƒã‚¯ã«ãªã‚Šã¾ã™
å…¥åŠ›å¤‰æ•°ã¯ã€`sys.query`ã«ã—ã¾ã™
å‡ºåŠ›å¤‰æ•°ã«ã€API Gateway ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå…¥ã‚Šã¾ã™
`â–·`ã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã¨ã€`text`ã« Knowledge Base ã®å›ç­”ãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™

![](/images/20241003_dify/101.png)
![](/images/20241003_dify/102.png)

#### LLM ãƒ–ãƒ­ãƒƒã‚¯

ç”Ÿæˆ AI ã«è³ªå•ã—ã¦å›ç­”ã‚’å¾—ã¾ã™
`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ`ã«ã¯ã€å‰ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã§å–å¾—ã—ãŸ Knowledge Base ã®å›ç­”ã‚’å…¥åŠ›ã—ã¾ã™
`SYSTEM`ã¨`USER`ã® 2 ã¤ã®å†…å®¹ã‚’å…ƒã«ç”Ÿæˆ AI ãŒå›ç­”ã‚’ç”Ÿæˆã—ã¾ã™
å›ç­”çµæœã¯ã€å‡ºåŠ›å¤‰æ•°`text`ã«å…¥ã‚Šã¾ã™

![](/images/20241003_dify/103.png)

#### å›ç­”ãƒ–ãƒ­ãƒƒã‚¯

å‰ã® LLM ãƒ–ãƒ­ãƒƒã‚¯ã§å¾—ãŸå›ç­”ã‚’å‡ºåŠ›ã—ã¾ã™
`/`ã§å¤‰æ•°ã¯å…¥åŠ›ã§ãã¾ã™
![](/images/20241003_dify/104.png)

#### `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼`ã‹ã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã¾ã™

```text
bedrock ã¨ teams ã¯é€£æºã§ãã¾ã™ã‹
```

![](/images/20241003_dify/105.png)

## Entra ID ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ è¨­å®šã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹

Dify ã«ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ã‚’å®Ÿè£…ã—ã¦æ¬²ã—ã„ã¨è¨€ã‚ã‚ŒãŸã®ã§â€¦

- Microsoft Entra ID ã¯ã€Azure(ã‚¯ãƒ©ã‚¦ãƒ‰)ã® AD ã‚µãƒ¼ãƒ
- AWS Cognito ã§ã€SAML ã‚’ä½¿ç”¨ã—ã¦ã€Microsoft Entra ID ã¨é€£æº
- ALB ã« Cognito ã‚’é–¢é€£ä»˜ã‘ã€ãƒªã‚¹ãƒŠãƒ¼ã« EC2 (Dify) ã‚’è¨­å®š

https://www.beex-inc.com/blog/AzureAD_Cognito_20230915
https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/cognito-user-pools-saml-idp.html

### Azure è¨­å®š

Azure ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã€`ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³`ã®ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™

![](/images/20241003_dify/106.png)

é©å½“ãªåå‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™
![](/images/20241003_dify/107.png)
![](/images/20241003_dify/108.png)

SSO (SAML) è¨­å®šã‚’ã—ã¾ã™
![](/images/20241003_dify/109.png)
![](/images/20241003_dify/110.png)

`ã‚¢ãƒ—ãƒªã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ URL`ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã™
![](/images/20241003_dify/112.png)

èªè¨¼ã•ã›ãŸã„ãƒ¦ãƒ¼ã‚¶ã‚’è¿½åŠ ã—ã¾ã™
![](/images/20241003_dify/113.png)
![](/images/20241003_dify/114.png)
![](/images/20241003_dify/115.png)

### ALB è¨­å®š

ALB ã‚’ä½œæˆã—ã¾ã™ (å…·ä½“çš„ãªä½œæˆæ–¹æ³•ã¯å‰²æ„›)
ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€Dify ã® EC2 ã‚’è¨­å®šã—ã€Security Group ã§ã€Dify ã® EC2 ã‹ã‚‰ ALB ã¸ã®é€šä¿¡ã‚’è¨±å¯ã—ã¾ã™
â€»Cognito ã¯ã€HTTPS ã—ã‹å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ACM ã§`SSL/TLS è¨¼æ˜æ›¸`ã‚’ç™ºè¡Œã—ã€`Route53`ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã—ã¦ã€HTTPS ã§é€šä¿¡ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„

â€»ALB ã¨ EC2 ã® Security Group è¨­å®šä¾‹
![](/images/20241003_dify/138.png)

â€»Route 53 è¨­å®šä¾‹
![](/images/20241003_dify/139.png)

### AWS Cognito è¨­å®š

![](/images/20241003_dify/116.png)
![](/images/20241003_dify/117.png)
![](/images/20241003_dify/118.png)
![](/images/20241003_dify/128.png)
SES ã®æ§‹ç¯‰æ–¹æ³•ã¯å‰²æ„›ã—ã¾ã™
â€»`Cognito ã§ E ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡`ã‚’é¸æŠã—ã¦ã‚‚å•é¡Œãªã„ã§ã™
![](/images/20241003_dify/129.png)

â€»SAML å±æ€§ã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¾ã™
ã€€ã“ã‚Œã¯ã€Entra ID ã‹ã‚‰æä¾›ã•ã‚Œã‚‹ãƒ¦ãƒ¼ã‚¶æƒ…å ±(email)ã‚’ Cognito ã®ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã€Cognito ãŒãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’æ­£ã—ãè§£é‡ˆã™ã‚‹ãŸã‚ã®è¨­å®šã§ã™
ã€€ä»¥ä¸‹ã‚’è¨­å®šã™ã‚‹ã¨ã€Entra ID ã«å¯¾ã—ã¦ Email ã‚’è¦æ±‚ã—ã€å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™
ã€€ãã®ä»–ã«è¦æ±‚ã§ãã‚‹å±æ€§ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„
https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/technical-reference/the-role-of-claims

```text
http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress
```

![](/images/20241003_dify/122.png)

â€»`ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ URL ã‚’å…¥åŠ›`ã«ã¯ã€Azure ã§ãƒ¡ãƒ¢ã—ã¦ãŠã„ãŸ`ã‚¢ãƒ—ãƒªã®ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ URL`ã‚’å…¥åŠ›ã—ã¾ã™
![](/images/20241003_dify/123.png)

è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ URL ã«ã¯ã€ä»¥ä¸‹ã‚’è¨­å®šã—ã¾ã™

```text
https://ALBã®DNSå/oauth2/idpresponse
```

![](/images/20241003_dify/127.png)

ä»¥ä¸Šã§ä½œæˆã—ã¾ã™

### Azure ã¨ Cognito ã®é€£æº

`è­˜åˆ¥å­ (ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ ID)`ã¨`å¿œç­” URL (Assertion Consumer Service URL)`ã‚’è¨­å®šã—ã¾ã™

è­˜åˆ¥å­

```text
urn:amazon:cognito:sp:Cognito ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ« ID
```

å¿œç­” URL

```text
https://Cognito ãƒ‰ãƒ¡ã‚¤ãƒ³/saml2/idpresponse
```

![](/images/20241003_dify/130.png)
![](/images/20241003_dify/132.png)

ãƒ†ã‚¹ãƒˆã—ã¦ã€å–å¾—ã§ãã‚‹å±æ€§ã‚’ç¢ºèªã—ã¾ã™
![](/images/20241003_dify/133.png)

ALB ã®ãƒªã‚¹ãƒŠãƒ¼ã§ã€Cognito ã‚’é–¢é€£ä»˜ã‘ã¾ã™
![](/images/20241003_dify/134.png)

ALB ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Cognito ã®ã‚µã‚¤ãƒ³ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
![](/images/20241003_dify/136.png)
![](/images/20241003_dify/137.png)

ä»¥ä¸Šã§ã™
ãŠç–²ã‚Œæ§˜ã§ã—ãŸ (o\_ \_)o
