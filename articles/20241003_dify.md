---
title: "Dify導入 個人メモ"
emoji: "🗂"
type: "tech"
topics: ["aws", "dify", "bedrock"]
published: true
---

急に RAG チャットボットを導入することになったので…
参考になれば幸いです
定期的に更新します
※2024/10/03 時点での情報です

## Install Docker Compose

https://zenn.dev/rock_penguin/articles/28875c7b0a5e30<br>
https://github.com/docker/compose/releases/<br>

※以下の v2.29.7 をインストール
https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64

```bash
sudo -s
cd
dnf update
dnf install -y docker
systemctl start docker
gpasswd -a $(whoami) docker
chgrp docker /var/run/docker.sock
systemctl restart docker
systemctl enable docker
curl -L "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
```

「uname -s」は OS 名、例えば「Linux」
「uname -m」は CPU アーキテクチャ、例えば「x86_64」<br>

```bash
docker -v
docker-compose -v
```

## Install Git

```bash
dnf install -y git
```

## Install Dify

https://docs.dify.ai/ja-jp/getting-started/install-self-hosted/docker-compose#difyno<br>
https://github.com/langgenius/dify/blob/main/docker/docker-compose.yaml<br>
https://docs.docker.jp/compose/profiles.html<br>

※以下のように記載があり、profiles で、qdrant をベクトルデータベースとして起動可能
　現在は、Qdrant が推奨されている

```yaml
# Qdrant vector store.
# (if used, you need to set VECTOR_STORE to qdrant in the api & worker service.)
qdrant:
image: langgenius/qdrant:v1.7.3
profiles:
  - qdrant
restart: always
volumes:
  - ./volumes/qdrant:/qdrant/storage
environment:
  QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
```

https://docs.dify.ai/ja-jp/getting-started/readme/features-and-specifications

```bash
git clone https://github.com/langgenius/dify.git
cd dify/docker
cp .env.example .env
docker-compose --profile qdrant up -d # qdrantをベクトルデータベースとして起動
docker-compose ps
```

以下でアクセスする

```bash
http://localhost/
http://グローバル IP アドレス/
```

## スペックについて

EC2 の IAMRole は、最低限 Bedrock へのアクセス権限を付与しておくように
EC2 インスタンスタイプは、t3.medium で起動可能
EBS は、最小で 7.3GB 使用した
Knowledge Base を使用してデータを蓄積する場合は、50 ～ 100GB くらいあっても良いと思う

## ログ・トレーシング

https://zenn.dev/aidemy/articles/13ceca39b0ea6c<br>
https://langfuse.com/pricing<br>

Langfuse が無料で使用可能

## Dify 設定エビデンス

### サインイン

適当なメールアドレスとパスワードでサインインする
※メールアドレスのチェックは行われないため、存在しないメールアドレスでも問題ないです

![](/images/20241003_dify/1.png)
![](/images/20241003_dify/2.png)
![](/images/20241003_dify/3.png)

### Dify 設定

設定画面に移動
![](/images/20241003_dify/4.png)

時刻設定
![](/images/20241003_dify/5.png)

LLM (Bedrock) 設定
※モデルへのアクセスは有効であること
![](/images/20241003_dify/7.png)
※適当に 1 つモデル ID をコピーします
![](/images/20241003_dify/8.png)
※IAM Role が割り当てられているため、アクセスキー設定は不要です
![](/images/20241003_dify/6.png)
![](/images/20241003_dify/9.png)

各モデル設定
![](/images/20241003_dify/10.png)
![](/images/20241003_dify/11.png)

### シンプルなチャットボットを作成 (動作確認)

![](/images/20241003_dify/12.png)
![](/images/20241003_dify/13.png)
※モデルを選択
![](/images/20241003_dify/14.png)
※更新する (何か設定変更したら更新して保存するように!)
![](/images/20241003_dify/15.png)

チャットボットを起動
![](/images/20241003_dify/16.png)

チャットしてみる
![](/images/20241003_dify/17.png)
![](/images/20241003_dify/18.png)
Claude 3 Haiku は、ChatGPT をベースに作られていることが分かりました…

## Langfuse 設定エビデンス

### Langfuse 起動

Dify と同様に Docker Compose で起動する

https://langfuse.com/docs/deployment/local<br>
https://note.com/jolly_dahlia842/n/n406dec2c11d9

```bash
sudo -s
cd
git clone https://github.com/langfuse/langfuse.git
cd langfuse
vi docker-compose.yml
```

以下に修正

1. ポート 3000 は、Dify が使用しているため、3002 に変更する
2. network を追加して、Dify と Langfuse を同じネットワークに配置する

```yaml
services:
  langfuse-server:
    image: langfuse/langfuse:2
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "3002:3000" # 変更
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/postgres
      - NEXTAUTH_SECRET=mysecret
      - SALT=mysalt
      - ENCRYPTION_KEY=0000000000000000000000000000000000000000000000000000000000000000
      - NEXTAUTH_URL=http://localhost:3002 # 変更
      - TELEMETRY_ENABLED=${TELEMETRY_ENABLED:-true}
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=${LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES:-false}
    networks: # 追加
      - langfuse_network # 追加

  db:
    image: postgres
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 3s
      timeout: 3s
      retries: 10
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - 5432:5432
    volumes:
      - database_data:/var/lib/postgresql/data
    networks: # 追加
      - langfuse_network # 追加

volumes:
  database_data:
    driver: local

networks: # 追加
  langfuse_network: # 追加
    name: langfuse_network # 追加
    driver: bridge # 追加
```

```bash
docker-compose up -d
docker-compose ps
docker network ls
```

以下でアクセスする

```bash
http://グローバル IP アドレス:3002/
```

Dify の docker-compose.yaml を修正し、Langfuse と同じネットワークに配置する

```bash
cd /root/dify/docker
vi docker-compose.yaml
```

以下、2 つの api と worker サービスに langfuse_network を追加する
※vi エディタで、/api と/worker で検索

```yaml
services:
  api:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: api
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # 追加

  worker:
    image: langgenius/dify-api:0.9.1
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    depends_on:
      - db
      - redis
    volumes:
      - ./volumes/app/storage:/app/api/storage
    networks:
      - ssrf_proxy_network
      - default
      - langfuse_network # 追加
```

ネットワーク設定にも追加
※/networks で検索

```yaml
networks:
  ssrf_proxy_network:
    driver: bridge
    internal: true
  milvus:
    driver: bridge
  opensearch-net:
    driver: bridge
    internal: true
  langfuse_network: # 追加
    name: langfuse_network # 追加
    external: true # 追加
```

Dify を再起動

```bash
docker-compose down
docker-compose up -d
docker-compose ps
```

### Langfuse と Dify の連携

アカウントを作成する
![](/images/20241003_dify/20.png)
![](/images/20241003_dify/21.png)

※なぜか localhost にリダイレクトされたので、アクセスできないと思ったら URL を確認してグローバル IP アドレスに戻して再接続すること

初期設定
![](/images/20241003_dify/22.png)
![](/images/20241003_dify/23.png)
![](/images/20241003_dify/24.png)
![](/images/20241003_dify/25.png)

API Key を作成する
![](/images/20241003_dify/26.png)
![](/images/20241003_dify/27.png)

Dify の設定画面に移動
※Host は、以下を設定する

```bash
http://langfuse-server:3000
```

![](/images/20241003_dify/19.png)
![](/images/20241003_dify/28.png)
![](/images/20241003_dify/29.png)

トレーシングの動作確認
※Dify のチャットボットを起動して、何か質問する
![](/images/20241003_dify/30.png)

Langfuse の画面に移動し、Trace を確認する
![](/images/20241003_dify/31.png)
![](/images/20241003_dify/32.png)

チャット内容や Token 数が確認できる
![](/images/20241003_dify/33.png)
