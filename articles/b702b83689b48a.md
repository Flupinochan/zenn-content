---
title: "AWS Amplify Gen 2ã«ãŠã‘ã‚‹Googleèªè¨¼è¨­å®š"
emoji: "ğŸ™Œ"
type: "tech"
topics:
  - "aws"
  - "amplify"
published: true
published_at: "2024-08-10 03:38"
---

## æ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI
ä»¥ä¸‹ãŒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ã™ãŒã€åˆ†ã‹ã‚Šã¥ã‚‰ã‹ã£ãŸãŸã‚ã€è¨­å®šä¾‹ã‚’å…±æœ‰ã—ã¾ã™
(ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ã¯ã¡ã‚ƒã‚“ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸâ€¦)
https://docs.amplify.aws/nextjs/build-a-backend/auth/concepts/external-identity-providers/

Cognitoã§Googleèªè¨¼ã™ã‚‹éš›ã«ã€è¨­å®šãŒèª¤ã£ã¦ã„ã‚‹ã¨ã€Œã‚¨ãƒ©ãƒ¼ 400: redirect_uri_mismatchã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/d2ea7f169acc-20240810.png)

åŸå› ã¨ã—ã¦ã¯ã€ã‚¨ãƒ©ãƒ¼æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°:ã€ã®URIãŒã€Google API Consoleã®èªè¨¼æƒ…å ±ã«ã¦ã€Œæ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URIã€ã«è¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã§ã™
![](https://storage.googleapis.com/zenn-user-upload/e2eb4892a6a1-20240810.png)

:::message alert
ã€Œæ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URIã€ã«ã¯ãƒ‘ã‚¹ã¾ã§å«ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„!
:::
ãƒ»æ‰¿èªæ¸ˆã¿ã® JavaScript ç”Ÿæˆå…ƒ ã®ä¾‹
```bash
https://be1748a04fef8dfa848d.auth.us-west-2.amazoncognito.com
```

ãƒ»æ‰¿èªæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ URI ã®ä¾‹
```bash
https://be1748a04fef8dfa848d.auth.us-west-2.amazoncognito.com/oauth2/idpresponse
```

Cognitoã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦ãã ã•ã„

![](https://storage.googleapis.com/zenn-user-upload/5bc328b637b3-20240810.png)

## amplify/auth/resource.ts
ã¤ã„ã§ã«å…±æœ‰ã—ã¾ã™
ã€ŒcallbackUrlsã€ã‚„ã€ŒlogoutUrlsã€ã¯ã€Cognitoã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ãªãã¦ã€è‡ªåˆ†ã®ã‚µã‚¤ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã—ã¾ã™
ã¾ãŸã€emailèªè¨¼ã¯å¿…é ˆã¿ãŸã„ã§ã™â€¦
```typescript
import { defineAuth, secret } from "@aws-amplify/backend";

export const auth = defineAuth({
  loginWith: {
    email: true,
    externalProviders: {
      google: {
        clientId: secret("GOOGLE_CLIENT_ID"),
        clientSecret: secret("GOOGLE_CLIENT_SECRET"),
        scopes: ["email"],
        attributeMapping: {
          email: "email",
        },
      },
      callbackUrls: ["http://localhost:3000/", "https://dev.chatbot.metalmental.net", "https://chatbot.metalmental.net"],
      logoutUrls: ["http://localhost:3000/", "https://dev.chatbot.metalmental.net", "https://chatbot.metalmental.net"],
    },
  },
});
```

æˆåŠŸä¾‹ã§ã™
è¦‹ãŸç›®ãŒè‰¯ããªã„ã®ã§Cognitoã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã—ãŸã„ã§ã™ã­â€¦
![](https://storage.googleapis.com/zenn-user-upload/6b95ad0adf98-20240810.png)

## ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
ã•ã‚‰ã«è£œè¶³ã§ã™
Googleã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®è¨­å®šã¯ã€ä»¥ä¸‹ãŒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«ãªã‚Šã¾ã™ãŒã€
æœ¬ç•ªç’°å¢ƒ(ãƒ–ãƒ©ãƒ³ãƒç’°å¢ƒ)ã¯AWS Management Consoleã®Amplifyã‹ã‚‰è¨­å®šã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã¯ã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šã—ã¾ã™â€¦
https://docs.amplify.aws/nextjs/deploy-and-host/fullstack-branching/secrets-and-vars/
