---
title: "AWS Amplify Gen 2 & IoT Core PubSubã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆ"
emoji: "ğŸ“‘"
type: "tech"
topics:
  - "aws"
  - "amplify"
  - "awsiotcore"
published: true
published_at: "2024-08-12 04:45"
---

AWS Summitã§API Gateway (WebSocket)ã®ä»£ã‚ã‚Šã«ã€IoT Core PubSub (MQTT Over WebSocket)ã‚’ä½¿ç”¨ã—ã¦ã„ã¦ã€èˆˆå‘³ã‚’æŒã£ãŸã®ã§ã‚„ã£ã¦ã¿ã¾ã—ãŸ!

(Claudeã¨ChatGPTã‚’åŒæ™‚å‡ºåŠ›ã—ã¦ã„ã‚‹ã®ã¯ãŸã ã®è¶£å‘³ã§ã™â€¦w)
![](https://storage.googleapis.com/zenn-user-upload/7aceba0b5f03-20240812.gif)

ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ãŒã€è¨­å®šã¯ã‚³ãƒ¼ãƒ‰ã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã€CLIãã‚Œãã‚Œã§å¿…è¦ã§ã™
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯ã€ã±ã£ã¨è¦‹ã¦ã€ã©ã“ã§è¨­å®šã™ã‚Œã°ã‚ˆã„ã®ã‹åˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸâ€¦
https://docs.amplify.aws/nextjs/build-a-backend/add-aws-services/pubsub/set-up-pubsub/

ãã®ãŸã‚ã€AWS Amplify PubSubã®è¨­å®šã‚’å…±æœ‰ã—ã¾ã™!

## AWS IoT ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
è¦‹ã¤ã‘ã‚‹ã®ãŒå¤§å¤‰ã§ã—ãŸâ€¦
![](https://storage.googleapis.com/zenn-user-upload/66c31e7d3d4d-20240812.png)

## AWS IoT IAM Policy
ã“ã‚Œã‚‚è¦‹ã¤ã‘ã‚‹ã®ãŒå¤§å¤‰ã§ã—ãŸâ€¦
![](https://storage.googleapis.com/zenn-user-upload/da3b5b1d5146-20240812.png)

## AWS IoT IAM Policyã«ã€Amazon Cognito Identity Idã‚’å‰²ã‚Šå½“ã¦ã‚‹
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã¯ã§ããªã„ã‚ˆã†ã§ã™
CLIã‚„SDKã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
æ‰‹é †è‡ªä½“ã¯é›£ã—ããªã„ã®ã§ã™ãŒã€Amazon Cognito Identity IdãŒåˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
Cognitoã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚„IDãƒ—ãƒ¼ãƒ«ã®IDãªã®ã‹ã¨æ€ã£ãŸã‚‰é•ã„ã¾ã—ãŸ
![](https://storage.googleapis.com/zenn-user-upload/363c6b8e27a3-20240812.png)

ã©ã†ã‚„ã‚‰ãƒ¦ãƒ¼ã‚¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚ˆã†ãªã‚‚ã®ã§ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ãŸã³ã«ä½œæˆã•ã‚Œã¦ã„ã¾ã™
ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã™ã‚‹ãŸã³ã«CLIã§è¨­å®šã™ã‚‹ã®ã¯é¢å€’ãªã®ã§ã€ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ãŸéš›ã«Cognito IDãƒ—ãƒ¼ãƒ«ã®Identity IDã‚’å–å¾—ã—ã€Lambdaã‚’å‘¼ã³å‡ºã—ã¦SDKã§ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ
```typescript
// Cognito Identity IDå–å¾—ä¾‹
import { Amplify } from "aws-amplify";
import { fetchAuthSession } from "aws-amplify/auth";
Amplify.configure(outputs);
const session = await fetchAuthSession({ forceRefresh: true });
const identityId = session.identityId as string;
```

```typescript
// Cognito Identity IDã«ã€AWS IoT IAM Policyã‚’å‰²ã‚Šå½“ã¦ã‚‹ä¾‹
import { IoTClient, AttachPolicyCommand } from "@aws-sdk/client-iot";
import { NodeHttpHandler } from "@aws-sdk/node-http-handler";
import type { Schema } from "../../data/resource";

const config = {
  region: "us-west-2",
  maxAttempts: 30,
  requestHandler: new NodeHttpHandler({
    connectionTimeout: 900000,
    socketTimeout: 900000,
  }),
};
const iotClient = new IoTClient(config);
const iotPolicyName = "amplify-iot-policy";

export const handler: Schema["PubSub"]["functionHandler"] = async (event) => {
  try {
    const cognitoIdentityId = event.arguments.cognitoIdentityId as string | undefined;
    console.log("Cognit Identity ID:", cognitoIdentityId);
    const command = new AttachPolicyCommand({
      policyName: iotPolicyName,
      target: cognitoIdentityId,
    });
    await iotClient.send(command);
    console.log("PubSubè¨­å®šãŒæˆåŠŸã—ã¾ã—ãŸ");
    return "PubSubè¨­å®šãŒæˆåŠŸã—ã¾ã—ãŸ";
  } catch (error) {
    console.error("An error occurred:", error);
    if (error instanceof Error) {
      return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: ${error.message}`;
    } else {
      return "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã¯ä¸æ˜ã§ã™ã€‚";
    }
  }
};
```

## Amazon Cognitoã®èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ã«å‰²ã‚Šå½“ã¦ã‚‹IAM Roleã«IoTã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã™ã‚‹
ç§ã¯ã‚³ãƒ¼ãƒ‰ã§è¡Œã„ã¾ã—ãŸ
```typescript
// amplify/backend.ts
// Cognitoã®èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ã®IAM Roleã«IoTã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ä¸ãˆã‚‹
import * as iam from "aws-cdk-lib/aws-iam";
import { defineBackend } from "@aws-amplify/backend";
import { auth } from "./auth/resource.js";
import { data } from "./data/resource.js";

const backend = defineBackend({
  auth,
  data,
});

backend.auth.resources.authenticatedUserIamRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AWSIoTDataAccess"));
backend.auth.resources.authenticatedUserIamRole.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName("AWSIoTConfigAccess"));
```

ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§IAM Roleã«ãƒãƒªã‚·ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™
![](https://storage.googleapis.com/zenn-user-upload/bc2ed0794b2e-20240812.png)
![](https://storage.googleapis.com/zenn-user-upload/37617c43b9f0-20240812.png)

## Subscribe (Websocket) å—ä¿¡ã™ã‚‹
ã“ã‚Œã§ç”ŸæˆAIã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã§ãã¾ã™
â€»æŠœç²‹ã—ã¦ã¾ã™
```typescript
import { useEffect, useState } from "react";
import { fetchUserAttributes } from "aws-amplify/auth";
import { PubSub } from "@aws-amplify/pubsub";
import { CONNECTION_STATE_CHANGE, ConnectionState } from "@aws-amplify/pubsub";
import { Hub } from "aws-amplify/utils";

const YourComponent = () => {
  const [email, setEmail] = useState<string>("");
  const [message, setMessage] = useState<string>("");

  useEffect(() => {
    const setupPubSub = async () => {
      try {
        if (!email) {
          // Cognitoã®èªè¨¼ã—ãŸãƒ¦ãƒ¼ã‚¶ã‹ã‚‰emailã‚’å–å¾—
          const attributes = await fetchUserAttributes();
          setEmail(attributes.email!);
        }

        const pubsub = new PubSub();
        // ãƒˆãƒ”ãƒƒã‚¯åã‚’emailã§ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–
        const sub = pubsub.subscribe({ topics: email }).subscribe({
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ãŸã‚‰messageã«æ ¼ç´ã™ã‚‹
          next: (data: any) => {
            setMessage((prevMessage) => prevMessage + data.message);
          },
          error: (error) => {
            console.error("Error in PubSub subscription:", error);
          },
          complete: () => {
            console.log("PubSub Session Completed");
          },
        });

        // ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const hubListener = Hub.listen("pubsub", (data: any) => {
          const { payload } = data;
          if (payload.event === CONNECTION_STATE_CHANGE) {
            const newState = payload.data.connectionState as ConnectionState;
            console.log("PubSub connection state changed:", newState);
          }
        });

        return () => {
          sub.unsubscribe();
          hubListener();
        };
      } catch (error) {
        console.error("Error setting up PubSub:", error);
      }
    };
    setupPubSub();
  }, [email]);
};

```

## Publish é€ä¿¡ã™ã‚‹
Bedrockã§ç”Ÿæˆã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’emailã®ãƒˆãƒ”ãƒƒã‚¯ã«é€ä¿¡ã™ã‚‹ä¾‹ã§ã™
```typescript
import { BedrockRuntimeClient, InvokeModelWithResponseStreamCommand } from "@aws-sdk/client-bedrock-runtime";
import { NodeHttpHandler } from "@aws-sdk/node-http-handler";
import { IoTDataPlaneClient, PublishCommand } from "@aws-sdk/client-iot-data-plane";
import type { Schema } from "../../data/resource";

const config = {
  region: "us-west-2",
  maxAttempts: 30,
  requestHandler: new NodeHttpHandler({
    connectionTimeout: 900000,
    socketTimeout: 900000,
  }),
};
const bedrock_client = new BedrockRuntimeClient(config);
const iot_client = new IoTDataPlaneClient(config);
const model_id = "anthropic.claude-3-sonnet-20240229-v1:0";

interface Message {
  role: string;
  message: string;
}

export const handler: Schema["ChatClaude"]["functionHandler"] = async (event) => {
  try {
    const rawContent = event.arguments.content as string[] | undefined;
    const topic = event.arguments.email as string | undefined;
    console.log("Raw content:", rawContent);
    let newContent;
    if (rawContent && Array.isArray(rawContent) && rawContent.length > 0) {
      const parsedContent = Array.isArray(rawContent[0]) ? rawContent[0] : JSON.parse(rawContent[0]);
      newContent = parsedContent.map((item: Message) => ({
        role: item.role,
        content: [{ type: "text", text: item.message }],
      }));
    } else {
      newContent = [{ role: "user", content: [{ type: "text", text: "ã“ã‚“ã«ã¡ã¯" }] }];
    }
    const payload = {
      anthropic_version: "bedrock-2023-05-31",
      max_tokens: 4000,
      messages: newContent,
    };
    const command = new InvokeModelWithResponseStreamCommand({
      modelId: model_id,
      contentType: "application/json",
      accept: "application/json",
      body: JSON.stringify(payload),
    });
    const response = await bedrock_client.send(command);

    if (response.body) {
      for await (const chunk of response.body) {
        const decodedChunk = new TextDecoder().decode(chunk.chunk?.bytes);
        try {
          const parsedChunk = JSON.parse(decodedChunk);
          if (parsedChunk.type === "content_block_delta" && parsedChunk.delta.text) {
            const chunkText = parsedChunk.delta.text;

            // ãƒãƒ£ãƒ³ã‚¯ã‚’å—ä¿¡ã™ã‚‹ãŸã³ã« IoT Core ã« publish
            const publishParams = {
              topic: topic,
              payload: JSON.stringify({ role: "claude", message: chunkText }), // claude role
            };
            await iot_client.send(new PublishCommand(publishParams));
            console.log("Published chunk successfully");
          }
        } catch (parseError) {
          console.error("Error parsing chunk:", parseError);
        }
      }
    } else {
      console.log("No response body received from Bedrock");
    }

    return "Streaming completed";
  } catch (error) {
    console.error("An error occurred:", error);
    throw new Error(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°: ${error instanceof Error ? error.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"}`);
  }
};

```


## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
ä½œæˆä¸­ã§ã™ãŒå®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™
å‚è€ƒã«ã©ã†ã!
https://github.com/Flupinochan/amplify-next-template/
https://www.chatbot.metalmental.net/

#### 2024/09/28 è¿½è¨˜
IoT Coreã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®Publishã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é †åºãŒä¿è¨¼ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™

ãã®ãŸã‚ã€ç”ŸæˆAIã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹éš›ã¯ã€sequence numberã‚’ã¤ã‘ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆå´ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é †åºã‚’ä¸¦ã³æ›¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„

![](/images/other/mqtt_sequence.png)

https://docs.aws.amazon.com/ja_jp/iot/latest/developerguide/mqtt.html#mqtt-retain