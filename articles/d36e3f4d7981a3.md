---
title: "EC2ã®ã‚³ãƒ¼ãƒ‰ã‚’CodeCommitã§ç®¡ç†ã™ã‚‹"
emoji: "ğŸ”–"
type: "tech"
topics:
  - "aws"
  - "ec2"
  - "codepipeline"
  - "codecommit"
  - "codebuild"
published: true
published_at: "2024-08-16 19:19"
---

EC2ã«ã‚ã‚‹Shell Scriptç­‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’CodeCommitã§ç®¡ç†ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã§ã™
CodeBuildã§rsyncã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ã™ãŒã€ã„ãã¤ã‹æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™

## ã‚­ãƒ¼ãƒšã‚¢ã‚’ä½œæˆã—ã¦EC2ã‚’èµ·å‹•ã—ã¾ã™
â€»ã‚­ãƒ¼ãƒšã‚¢ã®ä¸­èº«ã¯å¾Œã§ä½¿ç”¨ã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/390123d83273-20240816.png)

â€»Security Groupã¯CodeBuildã‹ã‚‰æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
ã€€ã“ã“ã§ã¯ã€EC2ã¨CodeBuildä¸¡æ–¹ã«ã€Œdefaultã€ã®Security Groupã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§å¯¾å¿œã—ã¾ã™
 ![](https://storage.googleapis.com/zenn-user-upload/a249e0ea339b-20240816.png)

## EC2ã«ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™
ã€Œ/home/ec2-userã€ã«ã€Œcodeã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã€é©å½“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™
ã¾ãŸã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³(ec2-user)ã«æ°—ã‚’ä»˜ã‘ã¦ãã ã•ã„
â€»CodeCommitã®ãƒ•ã‚¡ã‚¤ãƒ«ã«åŒæœŸã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ä»®ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ã€ã“ã®æ‰‹é †ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“
![](https://storage.googleapis.com/zenn-user-upload/2f1bfad46355-20240816.png)

## Secrets Managerã«ã‚­ãƒ¼ãƒšã‚¢(ç§˜å¯†éµ)ã‚’ç™»éŒ²ã—ã¾ã™
:::message alert
ã€Œãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚­ãƒ¼ãƒšã‚¢ã®ä¸­èº«ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„
:::
ä½œæˆç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/bd5f639a1ce8-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/f054777ab42a-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/128b6bf01d2d-20240816.png)
ä½œæˆã—ãŸå¾Œã®ç”»é¢
![](https://storage.googleapis.com/zenn-user-upload/181bb0c15dc6-20240816.png)

## VPC Endpointã‚’ä½œæˆã—ã¾ã™
CodeBuildã¯Subnetä¸Šã«èµ·å‹•ã™ã‚‹ã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶šã—ã‹ã§ããªã„ãŸã‚ã€NAT Gatewayã‚‚ã—ãã¯4ã¤ã®VPC Endpointã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

- s3
- secretsmanager
- git-codecommit
- logs

![](https://storage.googleapis.com/zenn-user-upload/b7f5d7777449-20240816.png)

## CodeCommitã«EC2ã¸åŒæœŸã—ãŸã„ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™
codeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åŒæœŸã—ãŸã„ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/74d10d73c4c6-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/5ac42322ab47-20240816.png)
buildspec.ymlã®ä¾‹ã§ã™
ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåã‚„EC2ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€åˆã‚ã›ã¦ãã ã•ã„
```yaml
# 1. Secrets Managerã¯ã€key-valueã‚¿ã‚¤ãƒ—ã§ã¯ãªãã€plaintextã‚¿ã‚¤ãƒ—ã«ã™ã‚‹ã“ã¨
# 2. CodeBuildã¯ã€Public Subnetã«èµ·å‹•ã—ã¦ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œãªã„ãŸã‚ã€NAT gatewayã‚‚ã—ãã¯VPC Endpointã‚’ä½œæˆã—ã¦ãŠãã“ã¨

version: 0.2

env:
  secrets-manager:
    SSH_KEY: "plaintext-ssh-key"

phases:
  pre_build:
    commands:
      - echo "Setting up SSH"
      - mkdir -p ~/.ssh
      - echo "$SSH_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
  build:
    commands:
      - echo "Starting rsync to EC2 instance"
      - rsync --delete -r -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" ./code ec2-user@172.31.2.91:/home/ec2-user/
```

## CodeBuildã¨CodePipelineã‚’è¨­å®šã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/a9201074ef86-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/c5cf06d63a84-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/458e8accf30c-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/3f8c08c051b3-20240816.png)
â€»CodeBuildã®IAM Roleã«ã€ã€ŒSecretsManagerReadWriteã€ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¦ã€SecretsManagerã‹ã‚‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
![](https://storage.googleapis.com/zenn-user-upload/281bebade207-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/1dfd6ed5a624-20240816.png)
â€»CodePipelineã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®ã¿ã®ãŸã‚å‰²æ„›ã—ã¾ã™

## CodeCommitã¨EC2ã®åŒæœŸã‚’ç¢ºèªã—ã¾ã™
ã€Œ--deleteã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦CodeCommitã«ãªã„README.mdç­‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã•ã‚Œã€test3.shã¯æ–°ãŸã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸ
![](https://storage.googleapis.com/zenn-user-upload/fffaebf08da0-20240816.png)
![](https://storage.googleapis.com/zenn-user-upload/cd61a2d18c04-20240816.png)
